<!doctype html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">

        <title>Web GL Fun!</title>

        <script src="/sylvester.js"> </script>
        <script src="/glUtils.js" type="text/javascript"> </script>
        <script src="/gameCode.js" type="text/javascript"> </script>
        <script src="/socket.io/socket.io.js"></script>

        <script id="shader-vs" type="x-shader/x-vertex">
  attribute vec3 vertexPosition;
  attribute vec3 vertexNormal;
  attribute vec2 vertexTexture;
  attribute vec4 vertexTangent;

  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;
  uniform mat3 normalMatrix;
  
  uniform mediump vec3 lightPosition;
  uniform mediump vec3 lightPosition2;
  uniform mediump vec3 lightPosition3;
  uniform mediump float lightingDisabled;
  
  varying mediump vec3 lightDistanceVector1;
  varying mediump vec3 lightDistanceVector2;
  varying mediump vec3 lightDistanceVector3;
  varying mediump vec3 lightVector1;
  varying mediump vec3 lightVector2;
  varying mediump vec3 lightVector3;
  varying mediump vec2 texCoord;
  
  void main(void) 
  {
    if (lightingDisabled<2.0)
    { 
    vec3 normal=normalMatrix*vertexNormal;
    vec4 vertexTangentA = vec4(normalMatrix*vertexTangent.xyz,vertexTangent.w);
    vec3 bitangent = cross(normal.xyz, vertexTangentA.xyz)*vertexTangentA.w;
    vec4 position=uMVMatrix * vec4(vertexPosition, 1.0);

    lightDistanceVector1 = lightPosition-position.xyz;
    lightVector1 = vec3(dot(lightDistanceVector1, vertexTangentA.xyz), dot(lightDistanceVector1, bitangent), dot(lightDistanceVector1, normal));
    lightDistanceVector2 = lightPosition2-position.xyz;
    lightVector2 = vec3(dot(vertexTangentA.xyz, lightDistanceVector2), dot(bitangent, lightDistanceVector2), dot(normal, lightDistanceVector2));
    lightDistanceVector3 = lightPosition3-position.xyz;
    lightVector3 = vec3(dot(vertexTangentA.xyz, lightDistanceVector3), dot(bitangent, lightDistanceVector3), dot(normal, lightDistanceVector3));

    gl_Position = uPMatrix * position;
    texCoord = vertexTexture;
    }
    else
    {
       gl_Position = vec4(vertexPosition,1.0);
       texCoord = vertexTexture;
    }
  }
</script>

<script id="shader-fs" type="x-shader/x-fragment">
  uniform sampler2D sampler;
  uniform sampler2D normalMap;
  uniform mediump float lightDistance;
  uniform mediump float lightDistance2;
  uniform mediump vec3 lightMaterial;
  uniform mediump vec3 lightMaterial2;
  uniform mediump vec3 lightMaterial3;
  uniform mediump vec2 texCoordAdd;
  uniform mediump float lightingDisabled;
  uniform mediump float kernel[9];
  uniform mediump vec2 bufferTextureSize;

  varying mediump vec3 lightDistanceVector1;
  varying mediump vec3 lightDistanceVector2;
  varying mediump vec3 lightDistanceVector3;
  varying mediump vec3 lightVector1;
  varying mediump vec3 lightVector2;
  varying mediump vec3 lightVector3;
  varying mediump vec2 texCoord;
  
  void main(void) {
    if (lightingDisabled==0.0)
    {
        mediump vec3 nNormal = vec3(-(2.0*texture2D(normalMap, texCoord).x - 1.0), (2.0*texture2D(normalMap, texCoord).yz - 1.0));
        
        mediump float distance1 = length(lightDistanceVector1);
        mediump float distance2 = length(lightDistanceVector2);
        mediump float distance3 = length(lightDistanceVector3);

        mediump vec3 lightDirection = normalize(lightVector1);
           
        mediump float dLevel = max(0.0, dot(nNormal, lightDirection));
        mediump float attenuation = min(lightDistance/(distance1*distance1),1.0);
        mediump vec3 lightColor =  dLevel*attenuation*lightMaterial;
        
        lightDirection = normalize(lightVector2);
           
        dLevel = max(0.0, dot(nNormal, lightDirection));
        attenuation = min(lightDistance2/(distance2*distance2),1.0);
        lightColor =  lightColor+ dLevel*attenuation*lightMaterial2;
        
        lightDirection = normalize(lightVector3);
           
        dLevel = max(0.0, dot(nNormal, lightDirection));
        attenuation = min(lightDistance2/(distance3*distance3),1.0);
        lightColor =  lightColor+ dLevel*attenuation*lightMaterial3;
       
        gl_FragColor = vec4(lightColor*texture2D(sampler, texCoord).xyz,1);
    }
    else
    {
       if (lightingDisabled==1.0)
       {
            gl_FragColor = vec4(texture2D(sampler, texCoord+texCoordAdd).xyz,1);
       }
       else if (lightingDisabled==2.0)
       {
            gl_FragColor = vec4(texture2D(sampler, texCoord).xyz,1);
       }
       else if (lightingDisabled==3.0)
       {
            mediump vec2 pixelDist = vec2(1.25/bufferTextureSize.x,1.25/bufferTextureSize.y);
            mediump vec4 color = texture2D(sampler, texCoord+pixelDist*vec2(-1.0,-1.0),2.0)*kernel[0];
            color += texture2D(sampler, texCoord+pixelDist*vec2(0.0,-1.0),2.0)*kernel[1];
            color += texture2D(sampler, texCoord+pixelDist*vec2(1.0,-1.0),2.0)*kernel[2];
            color += texture2D(sampler, texCoord+pixelDist*vec2(-1.0,0.0),2.0)*kernel[3];            
            color += texture2D(sampler, texCoord,2.0)*kernel[4];
            color += texture2D(sampler, texCoord+pixelDist*vec2(1.0,0.0),2.0)*kernel[5];
            color += texture2D(sampler, texCoord+pixelDist*vec2(-1.0,1.0),2.0)*kernel[6];
            color += texture2D(sampler, texCoord+pixelDist*vec2(0.0,1.0),2.0)*kernel[7];
            color += texture2D(sampler, texCoord+pixelDist*vec2(1.0,1.0),2.0)*kernel[8];
        mediump float kernelSum = kernel[0]+kernel[1]+kernel[2]+kernel[3]+kernel[4]+kernel[5]+kernel[6]+kernel[7]+kernel[8];
            if (kernelSum<0.0)
            {
               kernelSum=1.0;
            }
        gl_FragColor = vec4(1.0*color.xyz/kernelSum, 1.0);

       }
       else
       {
            gl_FragColor = vec4(1.0*texture2D(sampler, texCoord).xyz + 1.0*texture2D(normalMap, texCoord, 3.0).xyz, 1.0);   
       }
    }
  }
</script>

        <style>
            html, body {
              width:  100%;
              height: 100%;
              margin: 0px;
              }
            #glCanvas{
            width: 100%;
            }
            body{
            background-color: #000000 
            }
        </style>
    </head>

    <body onload="start()" id="WebPage">

    <!-- Code to tell user how to fix WebGL not working -->
    <div id="placeHolderA" style="display:none;">
        <a href="/webGLFix.html">
            <img src="/warning.png" alt="How to get the game working">
        </a>
    </div>

     <!--  -->
    <div id = "InputBox" style="position: absolute; z-index: 1; left: 50px; top: 164px;background-color: black; color: green;">
        </div>

    <div id = "ChatBox" style="position: absolute; z-index: 1; left: 70%; top: 164px;background-color: black; color: green;">
        </div>

  <canvas id="glCanvas" width="300" height="180" onClick="lockPointer()">
    Your browser doesn't appear to support the HTML5 <code>&lt;canvas&gt;</code> element.
  </canvas>
  <audio id="music1" hidden=true>
  <source src="http://www.thefourthestate.net/OwlieGL/test.wav" type="audio/wav">
  <source src="http://www.thefourthestate.net/OwlieGL/test.wav" type="audio/wav">
</audio>
<audio id="music2" hidden=true>
  <source src="http://www.thefourthestate.net/OwlieGL/test.wav" type='audio/wav' >
</audio>
    </body>
</html>
